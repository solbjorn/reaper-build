--[[-----------------------------------------------------------------------------------------------
 File         : sa_utils.script
 Description  : Вспомогательные функции
 Copyright    : Shadows Addon
 Author       : Ray Twitty aka Shadows
 Date         : 16.06.2013
 Last edit    : 08.11.2018
--]]-----------------------------------------------------------------------------------------------
_G.base_time_factor = level.get_time_factor()
_G.pressed_keys = {}
--[[-----------------------------------------------------------------------------------------------
 * Car
--]]-----------------------------------------------------------------------------------------------
function _G.change_car_health(obj, health)
	if obj and health > 0 then
		local car = obj:get_car()
		if car then
			car:SetfHealth(math.clamp(car:GetfHealth() + health, 0, 1))
		end
	end
end
---------------------------------------------------------------------------------------------------
function _G.change_car_fuel(obj, fuel)
	if obj and fuel > 0 then
		local car = obj:get_car()
		car:SetFuel(math.clamp(car:GetFuel() + fuel, 0, car:GetFuelTank()))
	end
end
--[[-----------------------------------------------------------------------------------------------
 * Sounds
--]]-----------------------------------------------------------------------------------------------
function _G.play_safe_sound_object(sound_path, timeout, volume)
	if sound_path then
		if not timeout then
			timeout = 0
		end
		if not volume then
			volume = 1.0
		end
		sound_object(sound_path):play_no_feedback(Actor, sound_object.s2d, timeout, xyz(), volume)
	end
end
--[[-----------------------------------------------------------------------------------------------
 * Particles
--]]-----------------------------------------------------------------------------------------------
local safe_particle_objects = {}
local safe_particle_objects_id = 0
---------------------------------------------------------------------------------------------------
function _G.safe_particle_object(particle_path)
	if particle_path then
		safe_particle_objects_id = safe_particle_objects_id + 1
		safe_particle_objects[safe_particle_objects_id] = particles_object(particle_path)
		return safe_particle_objects[safe_particle_objects_id]
	end
end
--[[-----------------------------------------------------------------------------------------------
 * Camera
--]]-----------------------------------------------------------------------------------------------
function _G.camera_rotate_on_position(pos, speed, action, ...)
	if pos and speed >= 1 and speed <= 20 then
		local args = {...}
		local current_dir = screen.cam_dir:mul(level.get_target_dist())
		local end_dir = pos:sub(screen.cam_pos)
		local current_angle = -current_dir:getH()
		local end_angle = -end_dir:getH()
		if vector():crossproduct(end_dir, screen.cam_dir).y > 0 then
			speed = -speed
		end
		level.add_call(
			function()
				if current_angle > 1.57 then
					current_angle = -4.71
				elseif current_angle < -4.71 then
					current_angle = 1.57
				end
				current_angle = current_angle + speed / 1000
				Actor:set_camera_direction(xyz(current_angle, 0, 0))
				return math.abs(current_angle - end_angle) < 0.01
			end,
			function()
				if action then
					loadstring("return function(args) "..action.."(unpack(args)) end")()(args)
				end
			end
		)
	end
end
--[[-----------------------------------------------------------------------------------------------
 * HUD
--]]-----------------------------------------------------------------------------------------------
function _G.add_message(xml, text, x, y, a, r, g, b)
	if xml and text then
		local st = hud:AddCustomStatic(xml, true):wnd()
		st:SetTextST(text)
		if x then st:SetTextX(x) end
		if y then st:SetTextY(y) end
		if a and r and g and b then st:SetTextColor(a, r, g, b) end
	end
end
--[[-----------------------------------------------------------------------------------------------
 * UI
--]]-----------------------------------------------------------------------------------------------
function _G.validate_list(list)
	if list and list:GetSize() ~= 0 then
		local index = list:GetSelectedItem()
		return index ~= -1 and list:GetItem(index)
	end
end
--[[-----------------------------------------------------------------------------------------------
 * Extended level namespace
--]]-----------------------------------------------------------------------------------------------
local gcfg = game_ini()
---------------------------------------------------------------------------------------------------
function level.indoor(lname)
	if not lname then
		if curr_level then
			lname = curr_level
		elseif level.present() then
			lname = level.name()
		else
			return false
		end
	end
	return gcfg:r_bool_cache(lname, "indoor", false)
end
---------------------------------------------------------------------------------------------------
function level.blowout(lname)
	if not lname then
		if curr_level then
			lname = curr_level
		elseif level.present() then
			lname = level.name()
		else
			return false
		end
	end
	if level.indoor(lname) then
		return false
	end
	return gcfg:r_bool_cache(lname, "blowout", true)
end
---------------------------------------------------------------------------------------------------
function level.parked_call(action, x)
	if not x then
		x = 1
	end
	level.add_call(
		function()
			x = x - 1
			return x == 0
		end,
		action
	)
end
--[[-----------------------------------------------------------------------------------------------
 * Others
--]]-----------------------------------------------------------------------------------------------
function _G.is_key_pressed(dik)
	return dik and pressed_keys[dik]
end
---------------------------------------------------------------------------------------------------
function _G.is_hud_draw()
	return console:get_bool("hud_draw")
end
---------------------------------------------------------------------------------------------------
function _G.toboolean(e)
	return e ~= nil and e ~= 0 and e ~= "0" and e ~= "false" and e ~= false
end
---------------------------------------------------------------------------------------------------
function _G.random_position(center, radius)
	center.x = center.x + math.random(-radius, radius)
	center.z = center.z + math.random(-radius, radius)
	return center
end
---------------------------------------------------------------------------------------------------
function _G.play_object_bones_particle(obj, particle_path)
	if obj and particle_path then
		local ini = obj:get_visual_ini()
		if ini and ini:section_exist("particle_bones") then
			local bones = ini:key_value("particle_bones")
			for k, v in pairs(bones) do
				safe_particle_object(particle_path):play_at_pos(obj:bone_position(k))
			end
		end
	end
end
---------------------------------------------------------------------------------------------------
function _G.make_hit(victim, power, impulse, type, direction, who, bone_name)
	if victim then
		if not type then type = hit.wound end
		if not direction then direction = xyz() end
		if not power then power = 1 end
		if not impulse then impulse = 1 end
		if not who then who = victim end
		local h = hit()
		h.type = type
		h.direction = direction
		if bone_name then
			h:bone(bone_name)
		end
		h.power = power
		h.impulse = impulse
		h.draftsman = who
		victim:hit(h)
	end
end
---------------------------------------------------------------------------------------------------
local names_cnt = { }
for i, group in ipairs({ "stalker", "bandit", "science", "private", "sergeant", "lieutenant", "captain" }) do
	names_cnt[group] = {
		name	= config:r_u32("stalker_names_" .. group, "name_cnt"),
		lname	= config:r_u32("stalker_names_" .. group, "last_name_cnt")
	}
end
---------------------------------------------------------------------------------------------------
function _G.generate_name(group)
	local cnt = names_cnt[group]
	if not cnt then
		return ""
	end
	local fname = translate("name_stalker_" .. math.random(cnt.name))
	local sname = translate("lname_stalker_" .. math.random(cnt.lname))
	return string.format("%s %s", fname, sname)
end
---------------------------------------------------------------------------------------------------
function _G.check_time_interval(hours_from, minutes_from, hours_to, minutes_to)
	local time_from = game.CTime():set_table({ hour = hours_from, ["min"] = minutes_from })
	local time_to = game.CTime():set_table({ hour = hours_to, ["min"] = minutes_to })
	local cur_time = game.CTime():set_table({
		hour	= level.get_time_hours(),
		["min"]	= level.get_time_minutes()
	})
	return cur_time >= time_from and cur_time < time_to
end
---------------------------------------------------------------------------------------------------
function _G.transform_number_to_date(_time)
	if not _time then
		return translate("ui_st_indefinitely")
	end
	local d = _time / 86400
	if d >= 1 then
		return math.ceil(d) .. " " .. translate("ui_st_days")
	end
	d = _time / 3600
	if d >= 1 then
		return math.ceil(d) .. " " .. translate("ui_st_hours")
	end
	d = _time / 60
	return math.ceil(d) .. " " .. translate("ui_st_mins")
end
---------------------------------------------------------------------------------------------------
function _G.send_tip(news_text, header, timeout, showtime, sender, sound)
	if news_text then
		if timeout ~= nil and timeout > 0 then
			timer("send_tip", timeout * 1000, true, news_text, header, 0, showtime, sender, sound)
			return
		end
		local sinfo = news_manager.sender_info_byname(sender, header)
		header = sinfo[3] or header or translate("st_tip")
		if not showtime then showtime = 5 end
		sound_object("device\\pda\\" .. (sound or "pda_tip")):play(Actor, 0, sound_object.s2d)
		Actor:give_game_news("%c[255,160,160,160]"..header.."\\n%c[default]"..news_text, "ui\\ui_iconsTotal", Frect():set(sinfo[1], sinfo[2], 83, 47), 0, showtime * 1000)
	end
end
